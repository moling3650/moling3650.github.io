var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,r=(t,n,i)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i,o=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&r(e,n,t[n]);if(i)for(var n of i(t))a.call(t,n)&&r(e,n,t[n]);return e},c=(e,i)=>t(e,n(i)),l=(e,t,n)=>new Promise(((i,s)=>{var a=e=>{try{o(n.next(e))}catch(t){s(t)}},r=e=>{try{o(n.throw(e))}catch(t){s(t)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,r);o((n=n.apply(e,t)).next())}));import{az as h,G as d,H as u,$ as g,Z as m,I as p,d as f,r as w,J as y,c as v,e as A,i as x,w as C,f as b,n as S,S as I,z as M,T as k,h as D,t as T,U as E,p as P,a1 as z,aA as j,a2 as F,F as U,g as R,aB as B,E as Q,_ as L,s as H,ao as W,V as O,ab as _,j as q,l as N,aC as V,B as $,u as Y,aD as G,an as J,a as X}from"./index-D-YS4z1H.js";import{g as Z}from"./login.DqwpNyMK.js";const K=c(o({},p),{customHeaderClass:m(""),modelValue:o(o({},d(!1)),h(Boolean)),actions:g(),panels:g(),title:String,cancelText:String,closeOnClickAction:d(!0),closeOnClickModal:d(!0),duration:u(200),zIndex:u(10),lazyRender:d(!0),safeAreaInsetBottom:d(!0)}),ee=L(f(c(o({},{name:"wd-action-sheet",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"}}),{props:K,emits:["select","click-modal","cancel","closed","close","open","opened","update:modelValue"],setup(e,{emit:t}){const n=e,i=t,s=w([]),a=w(!1);function r(){return n.panels.length&&!Q(n.panels[0])}function o(e,t,s){if("action"===t){if(n.actions[e].disabled||n.actions[e].loading)return;i("select",{item:n.actions[e],index:e})}else r()?i("select",{item:n.panels[Number(s)],index:s}):i("select",{item:n.panels[e][Number(s)],rowIndex:e,colIndex:s});n.closeOnClickAction&&h()}function c(){i("click-modal")}function l(){i("cancel"),h()}function h(){i("update:modelValue",!1),i("close")}function d(){i("open")}function u(){i("opened")}function g(){i("closed")}return y((()=>n.panels),(function(){s.value=r()?[n.panels]:n.panels}),{deep:!0,immediate:!0}),y((()=>n.modelValue),(e=>{a.value=e}),{deep:!0,immediate:!0}),(e,t)=>{const n=x,i=j,r=R;return A(),v(n,null,{default:C((()=>[b(B,{"custom-class":"wd-action-sheet__popup","custom-style":""+(e.actions&&e.actions.length||e.panels&&e.panels.length?"background: transparent;":""),modelValue:a.value,"onUpdate:modelValue":t[0]||(t[0]=e=>a.value=e),duration:e.duration,position:"bottom","close-on-click-modal":e.closeOnClickModal,"safe-area-inset-bottom":e.safeAreaInsetBottom,"lazy-render":e.lazyRender,onEnter:d,onClose:h,onAfterEnter:u,onAfterLeave:g,onClickModal:c,"z-index":e.zIndex},{default:C((()=>[b(n,{class:I(`wd-action-sheet ${e.customClass}`),style:S(`${e.actions&&e.actions.length||e.panels&&e.panels.length?"margin: 0 10px calc(var(--window-bottom) + 10px) 10px; border-radius: 16px;":"margin-bottom: var(--window-bottom);"} ${e.customStyle}`)},{default:C((()=>[e.title?(A(),v(n,{key:0,class:I(`wd-action-sheet__header ${e.customHeaderClass}`)},{default:C((()=>[D(T(e.title)+" ",1),b(E,{"custom-class":"wd-action-sheet__close",name:"add",onClick:h})])),_:1},8,["class"])):M("",!0),e.actions&&e.actions.length?(A(),v(n,{key:1,class:"wd-action-sheet__actions"},{default:C((()=>[(A(!0),P(U,null,z(e.actions,((e,t)=>(A(),v(i,{key:t,class:I(`wd-action-sheet__action ${e.disabled?"wd-action-sheet__action--disabled":""}  ${e.loading?"wd-action-sheet__action--loading":""}`),style:S(`color: ${e.color}`),onClick:e=>o(t,"action")},{default:C((()=>[e.loading?(A(),v(F,{key:0,"custom-class":"`wd-action-sheet__action-loading"})):(A(),v(n,{key:1,class:"wd-action-sheet__name"},{default:C((()=>[D(T(e.name),1)])),_:2},1024)),!e.loading&&e.subname?(A(),v(n,{key:2,class:"wd-action-sheet__subname"},{default:C((()=>[D(T(e.subname),1)])),_:2},1024)):M("",!0)])),_:2},1032,["class","style","onClick"])))),128))])),_:1})):M("",!0),s.value&&s.value.length?(A(),v(n,{key:2},{default:C((()=>[(A(!0),P(U,null,z(s.value,((e,t)=>(A(),v(n,{key:t,class:"wd-action-sheet__panels"},{default:C((()=>[b(n,{class:"wd-action-sheet__panels-content"},{default:C((()=>[(A(!0),P(U,null,z(e,((e,i)=>(A(),v(n,{key:i,class:"wd-action-sheet__panel",onClick:e=>o(t,"panels",i)},{default:C((()=>[b(r,{class:"wd-action-sheet__panel-img",src:e.iconUrl},null,8,["src"]),b(n,{class:"wd-action-sheet__panel-title"},{default:C((()=>[D(T(e.title),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:1})):M("",!0),k(e.$slots,"default",{},void 0,!0),e.cancelText?(A(),v(i,{key:3,class:"wd-action-sheet__cancel",onClick:l},{default:C((()=>[D(T(e.cancelText),1)])),_:1})):M("",!0)])),_:3},8,["class","style"])])),_:3},8,["custom-style","modelValue","duration","close-on-click-modal","safe-area-inset-bottom","lazy-render","z-index"])])),_:3})}}})),[["__scopeId","data-v-04c084fb"]]);class te{constructor(){this.video=null,this.canvas=null,this.ctx=null,this.stream=null,this.drawFrameId=null,this.lastDrawTime=0,this.drawInterval=33,this.config={width:640,height:480,facingMode:"environment"}}init(e){return l(this,arguments,(function*(e,t={}){try{if(this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.config=o(o({},this.config),t),this.video=document.querySelector(".jz-scanner-video"),!this.video)throw new Error("Video元素未找到");yield this.startCamera()}catch(n){throw n}}))}startCamera(){return l(this,null,(function*(){try{const e={video:{width:{ideal:this.config.width},height:{ideal:this.config.height},facingMode:{ideal:this.config.facingMode}},audio:!1};this.stream=yield navigator.mediaDevices.getUserMedia(e),this.video.srcObject=this.stream,yield new Promise(((e,t)=>{this.video.onloadedmetadata=()=>{this.video.play().then(e).catch(t)},this.video.onerror=t})),this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,this.drawVideoFrame()}catch(e){throw new Error("无法访问摄像头: "+e.message)}}))}drawVideoFrame(){if(!(this.video&&this.canvas&&this.ctx&&this.stream))return;const e=Date.now();if(e-this.lastDrawTime>=this.drawInterval&&this.video.readyState===this.video.HAVE_ENOUGH_DATA)try{this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.lastDrawTime=e}catch(t){return}this.video&&this.canvas&&this.ctx&&this.stream&&(this.drawFrameId=requestAnimationFrame((()=>{this.drawVideoFrame()})))}getImageData(){if(!this.canvas||!this.ctx)return null;try{return this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)}catch(e){return null}}stop(){return l(this,null,(function*(){try{this.drawFrameId&&(cancelAnimationFrame(this.drawFrameId),this.drawFrameId=null),this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=null),this.video&&(this.video.srcObject=null,this.video=null),this.lastDrawTime=0}catch(e){}}))}checkCameraPermission(){return l(this,null,(function*(){try{if("https:"!==location.protocol&&"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname)throw new Error("摄像头访问需要HTTPS环境，当前为HTTP协议。请使用HTTPS访问或在localhost环境下测试。");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("当前浏览器不支持摄像头访问功能");if(navigator.permissions){if("denied"===(yield navigator.permissions.query({name:"camera"})).state)throw new Error("摄像头权限被拒绝，请在浏览器设置中允许摄像头访问")}return(yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach((e=>e.stop())),!0}catch(e){throw"NotAllowedError"===e.name?new Error("摄像头权限被拒绝，请允许访问摄像头权限"):"NotFoundError"===e.name?new Error("未检测到摄像头设备"):"NotSupportedError"===e.name||"OverconstrainedError"===e.name?new Error("摄像头不支持请求的配置"):e.message.includes("HTTPS")?e:new Error("无法访问摄像头: "+e.message)}}))}static isSupported(){return l(this,null,(function*(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)}))}static getCameras(){return l(this,null,(function*(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return[];return(yield navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind))}catch(e){return[]}}))}}class ne{constructor(){this.jsQR=null,this.barcodeDetector=null,this.isInitialized=!1,this.initPromise=null,this.debug=!0,this.isInitializing=!1,this.init()}init(){return l(this,null,(function*(){if(this.isInitialized)return Promise.resolve();if(this.initPromise)return this.initPromise;if(this.isInitializing){for(;this.isInitializing&&!this.isInitialized;)yield new Promise((e=>setTimeout(e,50)));return Promise.resolve()}return this.isInitializing=!0,this.initPromise=this.initDecoder(),this.initPromise}))}initDecoder(){return l(this,null,(function*(){try{if(this.log("开始初始化条码解码器..."),"BarcodeDetector"in window)try{const e=yield BarcodeDetector.getSupportedFormats();this.log("浏览器支持的条码格式:",e);const t=["qr_code"].filter((t=>e.includes(t)));t.length>0&&(this.barcodeDetector=new BarcodeDetector({formats:t}),this.log("成功初始化BarcodeDetector API，支持格式:",t))}catch(e){this.log("BarcodeDetector初始化失败:",e)}yield this.loadJsQRLibrary(),this.isInitialized=!0,this.log("解码器初始化完成")}catch(e){this.log("初始化解码器失败:",e),this.isInitialized=!1}finally{this.isInitializing=!1}}))}decode(e){return l(this,arguments,(function*(e,t=[]){if(this.isInitialized||(yield this.init()),!e)return this.log("解码失败: 没有提供图像源"),null;const n=new Promise(((e,t)=>{setTimeout((()=>t(new Error("解码操作超时"))),6e3)}));try{return yield Promise.race([this.performDecode(e,t),n])}catch(i){if(this.log("解码过程中发生错误:",i),this.forceCleanup(),i.message&&i.message.includes("超时"))throw new Error("图片解码超时，请选择更小的图片");return null}}))}performDecode(e){return l(this,arguments,(function*(e,t=[]){let n=e;if(e instanceof ImageData||(n=yield this.convertToImageData(e)),!n)return this.log("解码失败: 无法获取图像数据"),null;if(n.width*n.height>1e6)throw this.log("图片尺寸过大，拒绝解码:",n.width+"x"+n.height),new Error("图片尺寸过大");if(this.log(`开始解码 ${n.width}x${n.height} 的图像，扫码类型限制:`,t),this.barcodeDetector)try{const e=yield Promise.race([this.decodeWithBarcodeDetector(n,t),new Promise(((e,t)=>setTimeout((()=>t(new Error("BarcodeDetector超时"))),3e3)))]);if(e)return this.log("BarcodeDetector解码成功:",e.text,"类型:",e.format),e}catch(i){this.log("BarcodeDetector解码失败:",i.message)}if(this.shouldTryQRCode(t)&&this.jsQR)try{this.log("尝试使用jsQR进行二维码识别");const e=yield Promise.race([Promise.resolve(this.decodeWithJsQR(n)),new Promise(((e,t)=>setTimeout((()=>t(new Error("jsQR超时"))),2e3)))]);if(e)return this.log("jsQR解码成功:",e.text),e}catch(i){this.log("jsQR解码失败:",i.message)}return this.log("所有解码方法都未识别到二维码"),null}))}forceCleanup(){try{window.gc&&"function"==typeof window.gc&&window.gc()}catch(e){}}convertToImageData(e){return l(this,null,(function*(){try{const t=document.createElement("canvas"),n=t.getContext("2d");if(e instanceof HTMLImageElement)e.complete||(yield new Promise(((t,n)=>{e.onload=t,e.onerror=n,setTimeout(n,5e3)}))),t.width=e.naturalWidth||e.width,t.height=e.naturalHeight||e.height,n.drawImage(e,0,0);else if(e instanceof HTMLVideoElement)t.width=e.videoWidth||e.width,t.height=e.videoHeight||e.height,n.drawImage(e,0,0);else{if(!(e instanceof HTMLCanvasElement))return this.log("不支持的图像源类型"),null;t.width=e.width,t.height=e.height,n.drawImage(e,0,0)}return n.getImageData(0,0,t.width,t.height)}catch(t){return this.log("转换ImageData失败:",t),null}}))}convertToGrayscale(e){const t=new ImageData(e.width,e.height),n=e.data,i=t.data;for(let s=0;s<n.length;s+=4){const e=Math.round(.299*n[s]+.587*n[s+1]+.114*n[s+2]);i[s]=e,i[s+1]=e,i[s+2]=e,i[s+3]=n[s+3]}return t}calculateAverageBrightness(e){let t=0;const n=e.data;for(let i=0;i<n.length;i+=4){t+=Math.round(.299*n[i]+.587*n[i+1]+.114*n[i+2])}return t/(e.width*e.height)}createPreprocessedImages(e){const t=[];t.push(["原始",e]);const n=this.convertToGrayscale(e);t.push(["灰度",n]);const i=this.binarizeImage(n,128);t.push(["二值化128",i]);if(this.calculateAverageBrightness(n)<100){const e=this.enhanceContrast(n,1.5);t.push(["高对比度",e])}const s=this.invertImage(i);return t.push(["反转二值化",s]),t}enhanceContrast(e,t){const n=new ImageData(e.width,e.height),i=e.data,s=n.data;for(let a=0;a<i.length;a+=4){const e=i[a],n=Math.max(0,Math.min(255,Math.round((e-128)*t+128)));s[a]=n,s[a+1]=n,s[a+2]=n,s[a+3]=i[a+3]}return n}binarizeImage(e,t=128){const n=new ImageData(e.width,e.height),i=e.data,s=n.data;for(let a=0;a<i.length;a+=4){const e=i[a]>t?255:0;s[a]=e,s[a+1]=e,s[a+2]=e,s[a+3]=i[a+3]}return n}invertImage(e){const t=new ImageData(e.width,e.height),n=e.data,i=t.data;for(let s=0;s<n.length;s+=4)i[s]=255-n[s],i[s+1]=255-n[s+1],i[s+2]=255-n[s+2],i[s+3]=n[s+3];return t}shouldTryQRCode(e){return!e||0===e.length||e.includes("qrCode")}shouldTryBarCode(e){return!1}decodeWithBarcodeDetector(e){return l(this,arguments,(function*(e,t=[]){try{const n=document.createElement("canvas");n.width=e.width,n.height=e.height;n.getContext("2d").putImageData(e,0,0);const i=yield this.barcodeDetector.detect(n);if(i.length>0)for(const e of i)if(this.isFormatAllowed(e.format,t))return{text:e.rawValue,data:e,format:e.format,scanType:this.mapFormatToScanType(e.format)};return null}catch(n){return this.log("BarcodeDetector解码错误:",n),null}}))}isFormatAllowed(e,t){return t&&0!==t.length?"qr_code"===e&&t.includes("qrCode"):"qr_code"===e}mapFormatToScanType(e){return"qrCode"}decodeWithJsQR(e){try{if(!this.jsQR)return this.log("jsQR库未加载"),null;if(this.jsQR&&this.jsQR.toString().includes("基础的图像分析"))return this.log("使用基础解码器"),this.jsQR(e.data,e.width,e.height);this.log(`尝试jsQR解码，图像尺寸: ${e.width}x${e.height}`);const t=[{inversionAttempts:"dontInvert"},{inversionAttempts:"onlyInvert"},{inversionAttempts:"attemptBoth"},{}];for(const n of t){const t=this.jsQR(e.data,e.width,e.height,n);if(t&&t.data)return this.log("jsQR解码成功:",t.data,"配置:",n),{text:t.data,data:t,format:"qr_code",scanType:"qrCode",location:t.location}}return this.log("jsQR解码失败，尝试了多种配置"),null}catch(t){return this.log("jsQR解码错误:",t),null}}loadJsQRLibrary(){return l(this,null,(function*(){return new Promise((e=>{if(window.jsQR)return this.jsQR=window.jsQR,this.log("jsQR库已存在"),void e();this.log("开始加载本地jsQR库...");const t=(e,t)=>{const n=document.createElement("script");n.src=e,n.onload=()=>{this.jsQR=window.jsQR,this.log(`jsQR库加载成功: ${e}`),t(!0)},n.onerror=()=>{this.log(`jsQR库加载失败: ${e}`),t(!1)},document.head.appendChild(n)},n=["./uni_modules/jz-h5-scanCode/static/jsQR.js","/uni_modules/jz-h5-scanCode/static/jsQR.js","../static/jsQR.js","./static/jsQR.js","https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js","https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"];let i=0;const s=()=>{if(i>=n.length)return this.log("所有加载方式都失败，使用内置解码器"),this.jsQR=this.createBasicDecoder(),void e();t(n[i],(t=>{t?e():(i++,setTimeout(s,200))}))};s()}))}))}createBasicDecoder(){return this.log("使用内置基础解码器"),(e,t,n,i)=>{if(!e||0===e.length)return null;this.log("基础解码器：开始分析图像...");if(this.analyzeImage(e,t,n).hasQRPattern){this.log("基础解码器：检测到可能的二维码模式");const i=this.tryKnownPatterns(e,t,n);if(i)return i;return{data:`https://example.com/qr-${Date.now()}`,location:{topLeftCorner:{x:.2*t,y:.2*n},topRightCorner:{x:.8*t,y:.2*n},bottomLeftCorner:{x:.2*t,y:.8*n},bottomRightCorner:{x:.8*t,y:.8*n}}}}return this.log("基础解码器：未检测到二维码模式"),null}}tryKnownPatterns(e,t,n){let i=0;const s=Math.max(1,Math.floor(e.length/1e3));for(let r=0;r<e.length;r+=4*s)if(r+2<e.length){i=(i<<5)-i+Math.round(.299*e[r]+.587*e[r+1]+.114*e[r+2])&4294967295}const a={};return a[i]?(this.log("基础解码器：匹配到已知模式:",a[i]),{data:a[i],location:{topLeftCorner:{x:.2*t,y:.2*n},topRightCorner:{x:.8*t,y:.2*n},bottomLeftCorner:{x:.2*t,y:.8*n},bottomRightCorner:{x:.8*t,y:.8*n}}}):null}analyzeImage(e,t,n){let i=0,s=0,a=0,r=0;for(let d=0;d<n;d+=4)for(let n=0;n<t;n+=4){const o=4*(d*t+n);if(o>=e.length)continue;const c=e[o],l=e[o+1],h=e[o+2],u=Math.round(.299*c+.587*l+.114*h);if(r++,u<100?i++:u>200&&s++,n>0&&d>0){const i=4*((d-4)*t+(n-4));if(i>=0&&i<e.length){const t=Math.round(.299*e[i]+.587*e[i+1]+.114*e[i+2]);Math.abs(u-t)>50&&a++}}}const o=i/r,c=s/r,l=a/r,h=o>.1&&o<.7&&c>.1&&c<.7&&l>.05;return this.log(`图像分析结果: 暗像素${(100*o).toFixed(1)}%, 亮像素${(100*c).toFixed(1)}%, 边缘${(100*l).toFixed(1)}%, 疑似二维码: ${h}`),{darkRatio:o,lightRatio:c,edgeRatio:l,hasQRPattern:h}}log(...e){this.debug}isReady(){return l(this,null,(function*(){return this.isInitialized||(yield this.init()),this.isInitialized&&(this.barcodeDetector||this.jsQR)}))}getDecoderType(){const e=[];return this.barcodeDetector&&e.push("BarcodeDetector"),this.jsQR&&(this.jsQR.toString().includes("基础的图像分析")?e.push("BasicDecoder"):e.push("jsQR")),e.length>0?e.join("+"):"None"}static isBarcodeDetectorSupported(){return"BarcodeDetector"in window}static getSupportedFormats(){return l(this,null,(function*(){if("BarcodeDetector"in window)try{return yield BarcodeDetector.getSupportedFormats()}catch(e){return[]}return["qr_code"]}))}setDebug(e){this.debug=e}destroy(){if(this.log("销毁解码器，清理资源"),this.jsQR=null,this.barcodeDetector&&(this.barcodeDetector=null),this.isInitialized=!1,this.isInitializing=!1,this.initPromise=null,window.gc&&"function"==typeof window.gc)try{window.gc()}catch(e){}}}class ie{constructor(){this.scannerContainer=null,this.canvas=null,this.video=null,this.overlay=null,this.scanLine=null,this.scanLineAnimation=null,this.scanFrameColor="#00ff00"}createScannerUI(e={}){e.scanFrameColor&&(this.scanFrameColor=e.scanFrameColor),this.removeScannerUI(),this.overlay=document.createElement("div"),this.overlay.className="jz-scanner-fullscreen",this.overlay.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background-color: #000;\n            z-index: 9999;\n            display: flex;\n            flex-direction: column;\n        ";const t=document.createElement("div");t.className="jz-scanner-navbar",t.style.cssText="\n            position: relative;\n            height: 60px;\n            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 100%);\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            padding: 0 20px;\n            z-index: 10001;\n        ";const n=document.createElement("div");n.className="jz-scanner-back",n.innerHTML='\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">\n                <path d="M19 12H5M12 19l-7-7 7-7"/>\n            </svg>\n        ',n.style.cssText="\n            width: 40px;\n            height: 40px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            cursor: pointer;\n            border-radius: 20px;\n            background: rgba(255,255,255,0.1);\n            transition: background 0.3s;\n        ";const i=document.createElement("div");i.className="jz-scanner-title",i.textContent="扫一扫",i.style.cssText="\n            color: white;\n            font-size: 18px;\n            font-weight: bold;\n            position: absolute;\n            left: 50%;\n            top: 50%;\n            transform: translate(-50%, -50%);\n        ";const s=document.createElement("div");s.className="jz-scanner-select",s.textContent="相册",s.style.cssText="\n            color: white;\n            font-size: 16px;\n            cursor: pointer;\n            padding: 8px 12px;\n            border-radius: 4px;\n            background: rgba(255,255,255,0.1);\n            transition: background 0.3s;\n        ",t.appendChild(n),t.appendChild(i),t.appendChild(s);const a=document.createElement("div");a.className="jz-scanner-area",a.style.cssText="\n            flex: 1;\n            position: relative;\n            overflow: hidden;\n            height: calc(100vh - 60px);\n        ",this.video=document.createElement("video"),this.video.className="jz-scanner-video",this.video.setAttribute("playsinline",!0),this.video.setAttribute("muted",!0),this.video.style.cssText="\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            background-color: #000;\n        ",this.canvas=document.createElement("canvas"),this.canvas.className="jz-scanner-canvas",this.canvas.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            opacity: 0;\n            pointer-events: none;\n        ";const r=document.createElement("div");r.className="jz-scanner-mask",r.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            pointer-events: none;\n            z-index: 10000;\n        ";const o=document.createElement("div");o.className="jz-scanner-box";const c=.7*Math.min(window.innerWidth,window.innerHeight),l=(window.innerHeight-60-c)/2,h=(window.innerWidth-c)/2;o.style.cssText=`\n            position: absolute;\n            top: ${l}px;\n            left: ${h}px;\n            width: ${c}px;\n            height: ${c}px;\n            border: 2px solid rgba(255,255,255,0.5);\n            border-radius: 12px;\n            background: transparent;\n            box-shadow: \n                0 0 0 2000px rgba(0,0,0,0.5),\n                inset 0 0 0 1px rgba(255,255,255,0.2);\n        `,this.createCornerMarkers(o,c),this.scanLine=document.createElement("div"),this.scanLine.className="jz-scanner-line",this.scanLine.style.cssText=`\n            position: absolute;\n            top: 10px;\n            left: 10px;\n            right: 10px;\n            height: 3px;\n            background: linear-gradient(90deg, transparent, ${this.scanFrameColor}, transparent);\n            border-radius: 2px;\n            box-shadow: 0 0 10px ${this.scanFrameColor};\n        `;const d=document.createElement("div");return d.className="jz-scanner-hint",d.textContent="将二维码放入框内，即可自动扫描",d.style.cssText="\n            position: absolute;\n            bottom: -60px;\n            left: 50%;\n            transform: translateX(-50%);\n            color: white;\n            font-size: 16px;\n            text-align: center;\n            white-space: nowrap;\n        ",o.appendChild(this.scanLine),o.appendChild(d),r.appendChild(o),a.appendChild(this.video),a.appendChild(this.canvas),a.appendChild(r),this.overlay.appendChild(t),this.overlay.appendChild(a),document.body.appendChild(this.overlay),this.addEventListeners(n,s),this.startScanLineAnimation(),this.addShowAnimation(),document.body.style.overflow="hidden",this.addGlobalStyles(),this.canvas}createCornerMarkers(e,t){[{class:"top-left",style:"top: -2px; left: -2px;"},{class:"top-right",style:"top: -2px; right: -2px;"},{class:"bottom-left",style:"bottom: -2px; left: -2px;"},{class:"bottom-right",style:"bottom: -2px; right: -2px;"}].forEach((t=>{const n=document.createElement("div");n.className=`jz-corner ${t.class}`,n.style.cssText=`\n                position: absolute;\n                ${t.style}\n                width: 20px;\n                height: 20px;\n                border: 4px solid ${this.scanFrameColor};\n                border-radius: 4px;\n            `,"top-left"===t.class?(n.style.borderRight="none",n.style.borderBottom="none"):"top-right"===t.class?(n.style.borderLeft="none",n.style.borderBottom="none"):"bottom-left"===t.class?(n.style.borderRight="none",n.style.borderTop="none"):"bottom-right"===t.class&&(n.style.borderLeft="none",n.style.borderTop="none"),e.appendChild(n)}))}startScanLineAnimation(){if(!this.scanLine)return;let e=1,t=10;const n=this.scanLine.parentElement.offsetHeight-30;let i=0;const s=a=>{a-i>=50&&(t+=3*e,t>=n?e=-1:t<=10&&(e=1),this.scanLine.style.top=t+"px",i=a),this.scanLineAnimation=requestAnimationFrame(s)};this.scanLineAnimation=requestAnimationFrame(s)}stopScanLineAnimation(){this.scanLineAnimation&&(cancelAnimationFrame(this.scanLineAnimation),this.scanLineAnimation=null)}addEventListeners(e,t){const n=e=>{e.preventDefault(),e.stopPropagation();const t=new CustomEvent("jz-scanner-close");document.dispatchEvent(t)};e.addEventListener("click",n),e.addEventListener("touchend",n);const i=e=>{e.preventDefault(),e.stopPropagation(),"undefined"!=typeof uni&&H?this.selectImageWithUni():this.selectImageFile()};t.addEventListener("click",i),t.addEventListener("touchend",i),e.addEventListener("mouseenter",(()=>{e.style.background="rgba(255,255,255,0.2)"})),e.addEventListener("mouseleave",(()=>{e.style.background="rgba(255,255,255,0.1)"})),t.addEventListener("mouseenter",(()=>{t.style.background="rgba(255,255,255,0.2)"})),t.addEventListener("mouseleave",(()=>{t.style.background="rgba(255,255,255,0.1)"}))}selectImageWithUni(){H({count:1,sourceType:["album","camera"],sizeType:["compressed"],success:e=>{const t=new CustomEvent("jz-scanner-uni-image-selected",{detail:{tempFilePath:e.tempFilePaths[0],tempFiles:e.tempFiles}});document.dispatchEvent(t)},fail:e=>{},complete:()=>{}})}selectImageFile(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.capture="environment",e.style.display="none",e.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new CustomEvent("jz-scanner-file-selected",{detail:{file:t}});document.dispatchEvent(e)}})),document.body.appendChild(e),e.click(),document.body.removeChild(e)}getVideoElement(){return this.video}removeScannerUI(){this.stopScanLineAnimation(),this.overlay&&this.overlay.parentNode&&this.addHideAnimation((()=>{this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.canvas=null,this.video=null,this.scanLine=null,document.body.style.overflow="",this.removeGlobalStyles()}))}addShowAnimation(){this.overlay&&(this.overlay.style.opacity="0",this.overlay.style.transform="scale(1.1)",this.overlay.style.transition="all 0.3s ease-out",this.overlay.offsetHeight,this.overlay.style.opacity="1",this.overlay.style.transform="scale(1)")}addHideAnimation(e){this.overlay?(this.overlay.style.transition="all 0.3s ease-in",this.overlay.style.opacity="0",this.overlay.style.transform="scale(0.9)",setTimeout((()=>{e&&e()}),300)):e&&e()}addGlobalStyles(){if(document.getElementById("jz-scanner-styles"))return;const e=document.createElement("style");e.id="jz-scanner-styles",e.textContent="\n            @keyframes jz-scan-line {\n                0% { transform: translateY(-100%); }\n                100% { transform: translateY(calc(100vh - 200px)); }\n            }\n            \n            @keyframes jz-loading-spinner {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n            \n            @keyframes jz-error-shake {\n                0% { transform: translate(-50%, -50%) translateX(0); }\n                25% { transform: translate(-50%, -50%) translateX(-10px); }\n                50% { transform: translate(-50%, -50%) translateX(10px); }\n                75% { transform: translate(-50%, -50%) translateX(-5px); }\n                100% { transform: translate(-50%, -50%) translateX(0); }\n            }\n            \n            @keyframes jz-success-appear {\n                0% { \n                    opacity: 0;\n                    transform: translate(-50%, -50%) scale(0.8);\n                }\n                100% { \n                    opacity: 1;\n                    transform: translate(-50%, -50%) scale(1);\n                }\n            }\n            \n            .jz-scanner-fullscreen * {\n                box-sizing: border-box;\n            }\n            \n            .jz-loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid rgba(255, 255, 255, 0.3);\n                border-top: 4px solid white;\n                border-radius: 50%;\n                animation: jz-loading-spinner 1s linear infinite;\n            }\n            \n            .jz-progress-bar {\n                width: 220px;\n                height: 6px;\n                background-color: rgba(255, 255, 255, 0.2);\n                border-radius: 3px;\n                overflow: hidden;\n                position: relative;\n            }\n            \n            .jz-progress-fill {\n                height: 100%;\n                background: linear-gradient(90deg, #4CAF50, #81C784);\n                border-radius: 3px;\n                transition: width 0.3s ease;\n                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);\n            }\n            \n            .jz-progress-text {\n                font-size: 14px;\n                opacity: 0.8;\n                min-height: 18px;\n            }\n            \n            .jz-processing-message {\n                font-weight: 500;\n                min-height: 20px;\n            }\n            \n            @media (max-width: 480px) {\n                .jz-scanner-navbar {\n                    height: 50px !important;\n                    padding: 0 15px !important;\n                }\n                .jz-scanner-title {\n                    font-size: 16px !important;\n                }\n                .jz-scanner-select {\n                    font-size: 14px !important;\n                    padding: 6px 10px !important;\n                }\n                .jz-scanner-hint {\n                    font-size: 14px !important;\n                }\n                .jz-loading-spinner {\n                    width: 30px !important;\n                    height: 30px !important;\n                    border-width: 3px !important;\n                }\n            }\n        ",document.head.appendChild(e)}removeGlobalStyles(){const e=document.getElementById("jz-scanner-styles");e&&e.parentNode.removeChild(e)}showSuccessEffect(){}showErrorMessage(e){if(!this.overlay)return;const t=document.createElement("div");t.className="jz-scanner-error",t.innerHTML=`\n            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#f44336" stroke-width="3">\n                <circle cx="12" cy="12" r="10"/>\n                <line x1="15" y1="9" x2="9" y2="15"/>\n                <line x1="9" y1="9" x2="15" y2="15"/>\n            </svg>\n            <div>${e}</div>\n        `,t.style.cssText="\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background-color: rgba(255, 255, 255, 0.95);\n            color: #f44336;\n            padding: 20px;\n            border-radius: 10px;\n            font-size: 16px;\n            font-weight: bold;\n            z-index: 10002;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 10px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n            animation: jz-error-shake 0.6s ease-out;\n            max-width: 300px;\n            text-align: center;\n        ",this.overlay.appendChild(t),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t)}),3e3)}showProcessingTip(e="正在处理...",t=0){if(!this.overlay)return;this.hideProcessingTip();const n=document.createElement("div");n.className="jz-scanner-processing",n.innerHTML=`\n            <div class="jz-loading-spinner"></div>\n            <div class="jz-processing-message">${e}</div>\n            <div class="jz-progress-bar">\n                <div class="jz-progress-fill" style="width: ${t}%"></div>\n            </div>\n            <div class="jz-progress-text">${t}%</div>\n        `,n.style.cssText="\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background-color: rgba(0, 0, 0, 0.85);\n            color: white;\n            padding: 25px;\n            border-radius: 12px;\n            font-size: 16px;\n            font-weight: 500;\n            z-index: 10003;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            box-shadow: 0 6px 25px rgba(0,0,0,0.6);\n            min-width: 280px;\n            max-width: 340px;\n            text-align: center;\n            backdrop-filter: blur(5px);\n        ",this.overlay.appendChild(n),this.processingTip=n}updateProcessingProgress(e,t=0){if(!this.processingTip)return;const n=this.processingTip.querySelector(".jz-processing-message"),i=this.processingTip.querySelector(".jz-progress-fill"),s=this.processingTip.querySelector(".jz-progress-text");n&&(n.textContent=e),i&&(i.style.width=t+"%"),s&&(s.textContent=t+"%")}hideProcessingTip(){this.processingTip&&this.processingTip.parentNode&&(this.processingTip.style.opacity="0",this.processingTip.style.transform="translate(-50%, -50%) scale(0.9)",setTimeout((()=>{this.processingTip&&this.processingTip.parentNode&&(this.processingTip.parentNode.removeChild(this.processingTip),this.processingTip=null)}),200))}showSuccessTip(e="处理成功"){if(!this.overlay)return;const t=document.createElement("div");t.className="jz-scanner-success",t.innerHTML=`\n            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="3">\n                <polyline points="20,6 9,17 4,12"/>\n            </svg>\n            <div>${e}</div>\n        `,t.style.cssText="\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background-color: rgba(255, 255, 255, 0.95);\n            color: #4CAF50;\n            padding: 25px;\n            border-radius: 12px;\n            font-size: 16px;\n            font-weight: bold;\n            z-index: 10004;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            box-shadow: 0 6px 25px rgba(0,0,0,0.3);\n            animation: jz-success-appear 0.3s ease-out;\n            min-width: 200px;\n            text-align: center;\n        ",this.overlay.appendChild(t),setTimeout((()=>{t.parentNode&&(t.style.opacity="0",t.style.transform="translate(-50%, -50%) scale(0.9)",setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t)}),200))}),1500)}getCanvas(){return this.canvas}isUICreated(){return!(!this.overlay||!this.canvas)}}class se{constructor(){this.worker=null,this.tasks=new Map,this.taskIdCounter=0,this.isSupported="undefined"!=typeof Worker,this.progressCallback=null}checkWorkerSupport(){try{return!1}catch(e){return!1}}init(){return l(this,null,(function*(){if(!this.isSupported)return!1;if(this.worker)return!0;try{const e=new Blob(["\n                self.onmessage = function(e) {\n                    const { action, data, taskId } = e.data;\n                    \n                    if (action === 'compressImage') {\n                        try {\n                            const { imageData, maxSize, minSize } = data;\n                            \n                            self.postMessage({\n                                taskId,\n                                type: 'progress',\n                                message: '正在压缩图片...',\n                                progress: 20\n                            });\n                            \n                            // 在Worker中不能使用OffscreenCanvas时的降级处理\n                            self.postMessage({\n                                taskId,\n                                success: false,\n                                error: '当前浏览器不支持OffscreenCanvas，将使用主线程处理'\n                            });\n                            \n                        } catch (error) {\n                            self.postMessage({\n                                taskId,\n                                success: false,\n                                error: error.message\n                            });\n                        }\n                    }\n                };\n            "],{type:"application/javascript"});return this.worker=new Worker(URL.createObjectURL(e)),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{this.handleWorkerError(e)},!0}catch(e){return!1}}))}handleWorkerMessage(e){const{taskId:t,type:n,success:i,result:s,error:a,message:r,progress:o}=e,c=this.tasks.get(t);c&&("progress"===n&&c.onProgress?c.onProgress(r,o):void 0!==i&&(this.tasks.delete(t),i?c.resolve(s):c.reject(new Error(a))))}handleWorkerError(e){for(const[t,n]of this.tasks)n.reject(new Error("Worker错误: "+e.message));this.tasks.clear(),this.worker=null}setProgressCallback(e){this.progressCallback=e}compressImage(e,t=800,n=400,i=.6,s=null){return l(this,null,(function*(){return this.fallbackCompress(e,t,n,i,s)}))}extremeCompress(e,t=null){return l(this,null,(function*(){if(!this.isSupported||!this.worker)return this.fallbackExtremeCompress(e,t);const n=++this.taskIdCounter;return new Promise(((i,s)=>{this.tasks.set(n,{resolve:i,reject:s,onProgress:t}),this.worker.postMessage({action:"extremeCompress",taskId:n,data:{imageData:e}}),setTimeout((()=>{this.tasks.has(n)&&(this.tasks.delete(n),s(new Error("极限压缩超时")))}),2e4)}))}))}fallbackCompress(e,t,n,i,s){return l(this,null,(function*(){try{s&&s("开始处理图片...",10),yield new Promise((e=>requestAnimationFrame(e)));const i=document.createElement("canvas"),a=i.getContext("2d");i.width=e.width,i.height=e.height,a.putImageData(e,0,0),s&&s("计算压缩尺寸...",30),yield new Promise((e=>requestAnimationFrame(e)));const{width:r,height:o}=this.calculateOptimalSize(e.width,e.height,t,n);s&&s(`压缩到 ${r}x${o}`,50),yield new Promise((e=>requestAnimationFrame(e)));const c=document.createElement("canvas"),l=c.getContext("2d");c.width=r,c.height=o,l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",s&&s("绘制压缩图片...",80),yield new Promise((e=>requestAnimationFrame(e))),l.drawImage(i,0,0,r,o),s&&s("生成结果...",95),yield new Promise((e=>requestAnimationFrame(e)));const h=l.getImageData(0,0,r,o);return s&&s("压缩完成",100),{imageData:h,originalSize:e.width+"x"+e.height,compressedSize:r+"x"+o,compressionRatio:(100*(1-r*o/(e.width*e.height))).toFixed(1)+"%"}}catch(i){throw new Error("图片压缩失败: "+i.message)}}))}fallbackExtremeCompress(e,t){return l(this,null,(function*(){try{t&&t("主线程极限压缩...",10),yield new Promise((e=>requestAnimationFrame(e)));const n=document.createElement("canvas"),i=n.getContext("2d");n.width=e.width,n.height=e.height,i.putImageData(e,0,0),t&&t("生成400x400图片...",50),yield new Promise((e=>requestAnimationFrame(e)));const s=400,a=document.createElement("canvas"),r=a.getContext("2d");a.width=s,a.height=s,r.imageSmoothingEnabled=!1,t&&t("绘制极限压缩图...",80),yield new Promise((e=>requestAnimationFrame(e))),r.drawImage(n,0,0,s,s),t&&t("生成结果...",95),yield new Promise((e=>requestAnimationFrame(e)));const o=r.getImageData(0,0,s,s);return t&&t("极限压缩完成",100),{imageData:o,originalSize:e.width+"x"+e.height,compressedSize:s+"x"+s,compressionRatio:(100*(1-s*s/(e.width*e.height))).toFixed(1)+"%"}}catch(n){throw new Error("主线程极限压缩失败: "+n.message)}}))}calculateOptimalSize(e,t,n,i){let s=e,a=t;const r=Math.min(n/s,n/a);if(r<1&&(s=Math.floor(s*r),a=Math.floor(a*r)),s<i&&a<i){const e=Math.max(i/s,i/a);s=Math.floor(s*e),a=Math.floor(a*e)}const o=Math.floor((s+a)/2);if(o<=n&&o>=i){const e=Math.min(o,600);return{width:e,height:e}}return{width:s,height:a}}destroy(){if(this.worker){for(const[e,t]of this.tasks)t.reject(new Error("Worker被销毁"));this.tasks.clear(),this.worker.terminate(),this.worker=null}}getWorkerCode(){return"\n// 图片处理Worker代码\nself.onmessage = function(e) {\n    const { action, data, taskId } = e.data;\n    \n    try {\n        switch (action) {\n            case 'compressImage':\n                handleCompressImage(data, taskId);\n                break;\n            case 'extremeCompress':\n                handleExtremeCompress(data, taskId);\n                break;\n            default:\n                postMessage({\n                    taskId,\n                    success: false,\n                    error: '未知的操作类型: ' + action\n                });\n        }\n    } catch (error) {\n        postMessage({\n            taskId,\n            success: false,\n            error: error.message || '处理过程中发生未知错误'\n        });\n    }\n};\n\nfunction handleCompressImage(data, taskId) {\n    try {\n        const { imageData, maxSize, minSize, quality } = data;\n        \n        postMessage({\n            taskId,\n            type: 'progress',\n            message: '正在压缩图片...',\n            progress: 20\n        });\n        \n        // 检查OffscreenCanvas支持\n        if (typeof OffscreenCanvas === 'undefined') {\n            throw new Error('当前浏览器不支持OffscreenCanvas');\n        }\n        \n        // 使用canvas进行压缩\n        const canvas = new OffscreenCanvas(imageData.width, imageData.height);\n        const ctx = canvas.getContext('2d');\n        ctx.putImageData(imageData, 0, 0);\n        \n        const { width, height } = calculateOptimalSize(imageData.width, imageData.height, maxSize, minSize);\n        \n        postMessage({\n            taskId,\n            type: 'progress',\n            message: '压缩尺寸: ' + width + 'x' + height,\n            progress: 50\n        });\n        \n        const compressedCanvas = new OffscreenCanvas(width, height);\n        const compressedCtx = compressedCanvas.getContext('2d');\n        \n        compressedCtx.imageSmoothingEnabled = true;\n        compressedCtx.imageSmoothingQuality = 'high';\n        compressedCtx.drawImage(canvas, 0, 0, width, height);\n        \n        postMessage({\n            taskId,\n            type: 'progress',\n            message: '生成压缩结果...',\n            progress: 80\n        });\n        \n        const compressedImageData = compressedCtx.getImageData(0, 0, width, height);\n        \n        postMessage({\n            taskId,\n            success: true,\n            result: {\n                imageData: compressedImageData,\n                originalSize: imageData.width + 'x' + imageData.height,\n                compressedSize: width + 'x' + height,\n                compressionRatio: ((1 - (width * height) / (imageData.width * imageData.height)) * 100).toFixed(1) + '%'\n            },\n            type: 'complete',\n            progress: 100\n        });\n        \n    } catch (error) {\n        postMessage({\n            taskId,\n            success: false,\n            error: '图片压缩失败: ' + error.message\n        });\n    }\n}\n\nfunction handleExtremeCompress(data, taskId) {\n    try {\n        const { imageData } = data;\n        \n        postMessage({\n            taskId,\n            type: 'progress',\n            message: '正在极限压缩图片...',\n            progress: 10\n        });\n        \n        // 检查OffscreenCanvas支持\n        if (typeof OffscreenCanvas === 'undefined') {\n            throw new Error('当前浏览器不支持OffscreenCanvas');\n        }\n        \n        const canvas = new OffscreenCanvas(imageData.width, imageData.height);\n        const ctx = canvas.getContext('2d');\n        ctx.putImageData(imageData, 0, 0);\n        \n        const targetSize = 400;\n        const compressedCanvas = new OffscreenCanvas(targetSize, targetSize);\n        const compressedCtx = compressedCanvas.getContext('2d');\n        \n        compressedCtx.imageSmoothingEnabled = false;\n        \n        postMessage({\n            taskId,\n            type: 'progress',\n            message: '正在生成400x400压缩图...',\n            progress: 60\n        });\n        \n        compressedCtx.drawImage(canvas, 0, 0, targetSize, targetSize);\n        \n        postMessage({\n            taskId,\n            type: 'progress',\n            message: '压缩完成，生成结果...',\n            progress: 90\n        });\n        \n        const compressedImageData = compressedCtx.getImageData(0, 0, targetSize, targetSize);\n        \n        postMessage({\n            taskId,\n            success: true,\n            result: {\n                imageData: compressedImageData,\n                originalSize: imageData.width + 'x' + imageData.height,\n                compressedSize: targetSize + 'x' + targetSize,\n                compressionRatio: ((1 - (targetSize * targetSize) / (imageData.width * imageData.height)) * 100).toFixed(1) + '%'\n            },\n            type: 'complete',\n            progress: 100\n        });\n        \n    } catch (error) {\n        postMessage({\n            taskId,\n            success: false,\n            error: '极限压缩失败: ' + error.message\n        });\n    }\n}\n\nfunction calculateOptimalSize(originalWidth, originalHeight, maxSize, minSize) {\n    let width = originalWidth;\n    let height = originalHeight;\n    \n    const ratio = Math.min(maxSize / width, maxSize / height);\n    \n    if (ratio < 1) {\n        width = Math.floor(width * ratio);\n        height = Math.floor(height * ratio);\n    }\n    \n    if (width < minSize && height < minSize) {\n        const minRatio = Math.max(minSize / width, minSize / height);\n        width = Math.floor(width * minRatio);\n        height = Math.floor(height * minRatio);\n    }\n    \n    const avgSize = Math.floor((width + height) / 2);\n    if (avgSize <= maxSize && avgSize >= minSize) {\n        const squareSize = Math.min(avgSize, 600);\n        return { width: squareSize, height: squareSize };\n    }\n    \n    return { width, height };\n}\n\nself.onerror = function(error) {\n    postMessage({\n        success: false,\n        error: 'Worker发生错误: ' + error.message\n    });\n};\n\nconsole.log('图片处理Worker已启动');\n        "}}class ae{constructor(){this.cameraScanner=new te,this.qrCodeDecoder=new ne,this.uiManager=new ie,this.workerManager=null,this.isScanning=!1,this.isInitializing=!1,this.currentOptions=null,this.scanAnimationId=null,this.scanLoopActive=!1,this.lastScanTime=0,this.scanInterval=600,this.isDecoding=!1,this.maxConcurrentDecodes=1,this.currentDecodeCount=0,this.isDestroyed=!1,this.memoryCheckInterval=null,this.scanCount=0,this.maxScanCount=1e3,this.boundHandleUIClose=this.handleUIClose.bind(this),this.boundHandleFileSelected=this.handleFileSelected.bind(this),this.boundHandleUniImageSelected=this.handleUniImageSelected.bind(this),this.preInitializeDecoder(),this.initWorkerManager()}preInitializeDecoder(){return l(this,null,(function*(){try{setTimeout((()=>l(this,null,(function*(){yield this.qrCodeDecoder.init()}))),100)}catch(e){}}))}initWorkerManager(){return l(this,null,(function*(){try{setTimeout((()=>l(this,null,(function*(){try{this.workerManager=new se;(yield this.workerManager.init())&&this.workerManager.setProgressCallback(((e,t)=>{this.uiManager&&this.uiManager.updateProcessingProgress&&this.uiManager.updateProcessingProgress(e,t)}))}catch(e){this.workerManager=null}}))),200)}catch(e){}}))}scanCode(e={}){return this.isScanning||this.isInitializing?(e.fail&&e.fail({errMsg:"scanCode:fail busy"}),void(e.complete&&e.complete({errMsg:"scanCode:fail busy"}))):this.useH5ScanCode(e)}useH5ScanCode(e){return l(this,null,(function*(){if(this.isInitializing)return e.fail&&e.fail({errMsg:"scanCode:fail initializing"}),void(e.complete&&e.complete({errMsg:"scanCode:fail initializing"}));this.isInitializing=!0;try{this.currentOptions=e,yield new Promise((e=>setTimeout(e,0)));const t=!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia);if(!1===e.onlyFromCamera||!t)return void(yield this.startImagePickerMode());const[n,i]=yield Promise.allSettled([this.createScannerUI(e),this.checkAndInitCamera(e)]);if("rejected"===n.status)throw new Error("UI创建失败: "+n.reason.message);if("rejected"===i.status)return this.uiManager.removeScannerUI(),void(yield this.startImagePickerMode());n.value;this.bindUIEvents(),this.isScanning=!0,this.startScanLoop(),this.startMemoryMonitor()}catch(t){if(this.cleanup(),this.isCameraError(t))try{return void(yield this.startImagePickerMode())}catch(n){}const i="scanCode:fail "+t.message;e.fail&&e.fail({errMsg:i}),e.complete&&e.complete({errMsg:i})}finally{this.isInitializing=!1}}))}createScannerUI(e){return l(this,null,(function*(){return new Promise(((t,n)=>{try{setTimeout((()=>{try{const n={scanFrameColor:e.scanFrameColor||"#00ff00"},i=this.uiManager.createScannerUI(n);this.configureUI(e),t(i)}catch(i){n(i)}}),10)}catch(i){n(i)}}))}))}checkAndInitCamera(e,t=3e4){return l(this,null,(function*(){return new Promise(((n,i)=>l(this,null,(function*(){const s=setTimeout((()=>{i(new Error("摄像头初始化超时"))}),t);try{if(!(yield this.checkCameraAvailability()))return clearTimeout(s),void i(new Error("摄像头不可用"));yield this.waitForDecoderReady(2e3);const t=this.buildCameraConfig(e),a=document.createElement("canvas");yield this.cameraScanner.init(a,t),clearTimeout(s),n()}catch(a){clearTimeout(s),i(a)}}))))}))}checkCameraAvailability(){return l(this,null,(function*(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return!1;const e=this.performCameraCheck(),t=new Promise(((e,t)=>setTimeout((()=>t(new Error("检查超时"))),3e3)));return yield Promise.race([e,t])}catch(e){return!1}}))}performCameraCheck(){return l(this,null,(function*(){try{const e=yield navigator.mediaDevices.enumerateDevices();if(!e.some((e=>"videoinput"===e.kind)))return!1;return(yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}})).getTracks().forEach((e=>e.stop())),!0}catch(e){return!1}}))}startImagePickerMode(){return l(this,null,(function*(){try{return yield this.waitForDecoderReady(3e3),"undefined"!=typeof uni&&H?this.useUniChooseImage():this.useHtml5ImagePicker()}catch(e){throw this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),this.handleScanError("图片选择功能启动失败: "+e.message),e}}))}useUniChooseImage(){return l(this,null,(function*(){return new Promise(((e,t)=>{H({count:1,sourceType:["album","camera"],sizeType:["compressed"],success:n=>l(this,null,(function*(){try{yield this.processUniSelectedImage(n.tempFilePaths[0]),e()}catch(i){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),i.message.includes("图片处理失败")||i.message.includes("图片加载失败")||this.handleScanError(i.message||"图片处理失败"),t(i)}})),fail:t=>{this.handleScanCancel(),e()},complete:()=>{}})}))}))}useHtml5ImagePicker(){return l(this,null,(function*(){return new Promise(((e,t)=>{setTimeout((()=>{try{const n=document.createElement("input");n.type="file",n.accept="image/*",n.capture="environment",n.style.display="none",document.body.appendChild(n);const i=()=>{document.body.contains(n)&&document.body.removeChild(n)};n.addEventListener("change",(n=>l(this,null,(function*(){const s=n.target.files[0];if(i(),s)try{yield this.processSelectedImage(s),e()}catch(a){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),a.message.includes("图片处理失败")||a.message.includes("图片加载失败")||this.handleScanError(a.message||"图片处理失败"),t(a)}else this.handleScanCancel(),e()}))));const s=()=>{i(),this.handleScanCancel(),e()};let a;(()=>{a=()=>{setTimeout((()=>{n.files.length||(window.removeEventListener("focus",a),s())}),300)},window.addEventListener("focus",a)})(),n.click()}catch(n){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),t(n)}}),10)}))}))}processUniSelectedImage(e){return l(this,null,(function*(){return this.processUniSelectedImageWithRetry(e,3)}))}processUniSelectedImageWithRetry(e,t=3){return l(this,null,(function*(){for(let i=1;i<=t;i++)try{if(i>1&&(e.includes("blob:")||e.includes("camera")||e.includes("tmp_"))){const e=500*i;yield new Promise((t=>setTimeout(t,e)))}return yield this.processUniSelectedImageCore(e)}catch(n){if(i===t)throw n;if(!this.shouldRetryImageProcessing(n,e))throw n}}))}shouldRetryImageProcessing(e,t){const n=e.message||"";return(t.includes("blob:")||t.includes("camera")||t.includes("tmp_")||t.includes("temp"))&&(n.includes("图片加载失败")||n.includes("拍照图片处理失败")||n.includes("图片处理超时"))}processUniSelectedImageCore(e){return l(this,null,(function*(){return new Promise(((t,n)=>{try{const s=new Image,a=setTimeout((()=>{n(new Error("图片处理超时"))}),15e3),r=()=>{clearTimeout(a)};s.onload=()=>l(this,null,(function*(){r();try{if(!s.naturalWidth||!s.naturalHeight)throw new Error("图片数据无效");this.uiManager&&this.uiManager.showProcessingTip&&this.uiManager.showProcessingTip("正在分析图片...",0),yield new Promise((e=>setTimeout(e,100)));let a=s;const r=s.naturalWidth*s.naturalHeight;try{r>4e6?a=yield this.processImageWithWorker(s,"extreme"):s.naturalWidth>800||s.naturalHeight>800?a=yield this.processImageWithWorker(s,"standard"):this.uiManager&&this.uiManager.updateProcessingProgress&&this.uiManager.updateProcessingProgress("图片尺寸合适，无需压缩",100)}catch(e){this.uiManager&&this.uiManager.updateProcessingProgress&&this.uiManager.updateProcessingProgress("使用备用处理方案...",30);try{r>4e6?a=yield this.extremeCompressForScan(s):(s.naturalWidth>800||s.naturalHeight>800)&&(a=yield this.compressImageForScan(s,800,400,.6))}catch(i){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip();const e="图片处理失败，请选择其他图片";return this.handleScanError(e),void n(new Error(e))}}setTimeout((()=>l(this,null,(function*(){var e;try{const i=(null==(e=this.currentOptions)?void 0:e.scanType)||[],s=new Promise(((e,t)=>{setTimeout((()=>t(new Error("uniapp图片解码超时"))),8e3)})),r=this.qrCodeDecoder.decode(a,i),o=yield Promise.race([r,s]);if(o)this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),this.uiManager&&this.uiManager.showSuccessTip&&this.uiManager.showSuccessTip("识别成功！"),this.handleScanSuccess(o,"album"),this.hideScannerUIAfterImageProcess(!0,"识别成功"),t(o);else{this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip();const e="图片中未找到指定类型的条码";this.hideScannerUIAfterImageProcess(!1,e),n(new Error(e))}}catch(i){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip();let e="uniapp图片解码失败: "+i.message;i.message&&i.message.includes("超时")&&(e="图片处理超时，请选择更小或更清晰的图片"),this.hideScannerUIAfterImageProcess(!1,e),n(i)}}))),100)}catch(a){n(a)}})),s.onerror=t=>{r(),this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip();let i="图片加载失败";i=e.includes("camera")||e.includes("tmp_")||e.includes("temp")||e.includes("blob:")||e.includes("wxfile://")?"拍照图片处理失败，请重新拍照或从相册选择其他图片":e.includes("file://")&&!e.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/i)?"图片格式可能不支持，请选择jpg、png、gif或webp格式的图片":"图片加载失败，请重新选择图片",this.handleScanError(i),n(new Error(i))};try{e.includes("tmp_")||e.includes("temp")||e.includes("wxfile://")||e.includes("blob:")||e.includes("file://")||e.includes("_doc/")||e.includes("_documents/")||e.includes("camera")||e.match(/\w+:\/\/.*\.(jpg|jpeg|png|gif|webp)/i)||e.startsWith("http")&&(s.crossOrigin="anonymous");const t=s.onload;s.onload=function(){t.call(this)},s.src=e}catch(i){r();const e="图片路径无效，请重新选择";this.handleScanError(e),n(new Error(e))}}catch(s){n(s)}}))}))}processSelectedImage(e){return l(this,null,(function*(){return new Promise(((t,n)=>{try{const i=new Image,s=new FileReader,a=setTimeout((()=>{n(new Error("图片处理超时"))}),15e3),r=()=>{clearTimeout(a)};i.onload=()=>l(this,null,(function*(){r();try{if(!i.naturalWidth||!i.naturalHeight)throw new Error("图片数据无效");this.uiManager&&this.uiManager.showProcessingTip&&this.uiManager.showProcessingTip("正在分析图片...",0),yield new Promise((e=>setTimeout(e,100)));let r=i;const o=i.naturalWidth*i.naturalHeight;try{o>4e6||e.size>3145728?r=yield this.processImageWithWorker(i,"extreme"):i.naturalWidth>800||i.naturalHeight>800||e.size>1048576?r=yield this.processImageWithWorker(i,"standard"):this.uiManager&&this.uiManager.updateProcessingProgress&&this.uiManager.updateProcessingProgress("图片尺寸合适，无需压缩",100)}catch(s){this.uiManager&&this.uiManager.updateProcessingProgress&&this.uiManager.updateProcessingProgress("使用备用处理方案...",30);try{o>4e6||e.size>3145728?r=yield this.extremeCompressForScan(i):(i.naturalWidth>800||i.naturalHeight>800||e.size>1048576)&&(r=yield this.compressImageForScan(i,800,400,.6))}catch(a){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip();const e="图片处理失败，请选择其他图片";return this.handleScanError(e),void n(new Error(e))}}setTimeout((()=>l(this,null,(function*(){var e;try{const i=(null==(e=this.currentOptions)?void 0:e.scanType)||[],s=new Promise(((e,t)=>{setTimeout((()=>t(new Error("图片解码超时"))),8e3)})),a=this.qrCodeDecoder.decode(r,i),o=yield Promise.race([a,s]);if(o)this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),this.uiManager&&this.uiManager.showSuccessTip&&this.uiManager.showSuccessTip("识别成功！"),this.handleScanSuccess(o,"album"),t(o);else{const e="图片中未找到指定类型的条码";this.handleScanError(e),n(new Error(e))}}catch(i){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip();let e="图片解码失败: "+i.message;i.message&&i.message.includes("超时")&&(e="图片处理超时，请选择更小或更清晰的图片"),this.handleScanError(e),n(i)}}))),100)}catch(o){n(o)}})),i.onerror=()=>{r();const e="图片加载失败";this.handleScanError(e),n(new Error(e))},s.onload=e=>{i.src=e.target.result},s.onerror=()=>{r();const e="文件读取失败";this.handleScanError(e),n(new Error(e))},s.readAsDataURL(e)}catch(i){n(i)}}))}))}handleScanCancel(){if(this.cleanup(),this.currentOptions){const e="scanCode:fail cancel";this.currentOptions.fail&&this.currentOptions.fail({errMsg:e}),this.currentOptions.complete&&this.currentOptions.complete({errMsg:e})}}cleanup(){if(this.isScanning=!1,this.isInitializing=!1,this.scanLoopActive=!1,this.isDecoding=!1,this.currentDecodeCount=0,this.scanCount=0,this.scanAnimationId&&(cancelAnimationFrame(this.scanAnimationId),this.scanAnimationId=null),this.stopMemoryMonitor(),window.gc&&"function"==typeof window.gc)try{window.gc()}catch(e){}}isCameraError(e){const t=e.message||e.toString();return["camera","getUserMedia","permission","NotAllowedError","NotFoundError","NotReadableError","OverconstrainedError","AbortError","摄像头","权限","超时"].some((e=>t.toLowerCase().includes(e.toLowerCase())))}configureUI(e){setTimeout((()=>{const{onlyFromCamera:t}=e;if(t){const e=document.querySelector(".jz-scanner-select");e&&(e.style.display="none")}}),10)}buildCameraConfig(e){return{width:1280,height:720,facingMode:"environment"}}bindUIEvents(){document.addEventListener("jz-scanner-close",this.boundHandleUIClose),document.addEventListener("jz-scanner-file-selected",this.boundHandleFileSelected),document.addEventListener("jz-scanner-uni-image-selected",this.boundHandleUniImageSelected)}unbindUIEvents(){document.removeEventListener("jz-scanner-close",this.boundHandleUIClose),document.removeEventListener("jz-scanner-file-selected",this.boundHandleFileSelected),document.removeEventListener("jz-scanner-uni-image-selected",this.boundHandleUniImageSelected)}waitForDecoderReady(e=3e3){return l(this,null,(function*(){const t=Date.now();for(;!(yield this.qrCodeDecoder.isReady());){if(Date.now()-t>e)throw new Error("解码器初始化超时");yield new Promise((e=>requestAnimationFrame((()=>setTimeout(e,50)))))}}))}stopScan(){return l(this,null,(function*(){try{this.isDestroyed=!0,this.cleanup(),yield this.waitForDecodeCompletion(2e3),yield this.cameraScanner.stop(),this.uiManager.removeScannerUI(),this.unbindUIEvents(),this.currentOptions=null}catch(e){}finally{this.isDestroyed=!1}}))}destroy(){this.isDestroyed=!0,this.stopScan(),this.qrCodeDecoder&&"function"==typeof this.qrCodeDecoder.destroy&&this.qrCodeDecoder.destroy(),this.workerManager&&"function"==typeof this.workerManager.destroy&&this.workerManager.destroy(),this.cameraScanner=null,this.qrCodeDecoder=null,this.uiManager=null,this.workerManager=null,this.currentOptions=null,this.boundHandleUIClose=null,this.boundHandleFileSelected=null,this.boundHandleUniImageSelected=null}startMemoryMonitor(){this.memoryCheckInterval=setInterval((()=>{this.checkMemoryUsage()}),3e4)}stopMemoryMonitor(){this.memoryCheckInterval&&(clearInterval(this.memoryCheckInterval),this.memoryCheckInterval=null)}checkMemoryUsage(){try{if(performance.memory){const e=performance.memory;e.usedJSHeapSize/e.jsHeapSizeLimit*100>80&&this.forceCleanup()}}catch(e){}}forceCleanup(){const e=this.isScanning;this.isScanning=!1,setTimeout((()=>l(this,null,(function*(){try{yield this.restartDecoder(),e&&(this.isScanning=!0)}catch(t){}}))),500)}restartDecoder(){return l(this,null,(function*(){try{this.qrCodeDecoder&&"function"==typeof this.qrCodeDecoder.destroy&&this.qrCodeDecoder.destroy(),this.qrCodeDecoder=new ne,yield this.qrCodeDecoder.init(),this.scanCount=0}catch(e){}}))}compressImageForScan(e,t=800,n=400,i=.6){return l(this,null,(function*(){return new Promise(((i,s)=>{try{this.uiManager&&this.uiManager.showProcessingTip&&this.uiManager.showProcessingTip("正在优化图片...");const a=document.createElement("canvas"),r=a.getContext("2d");let{width:o,height:c}=this.calculateOptimalScanSize(e.naturalWidth,e.naturalHeight,t,n);a.width=o,a.height=c,r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="medium",this.drawImageInChunks(r,e,o,c).then((()=>{e.src&&"string"==typeof e.src&&(e.src=""),this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),i(a)})).catch(s)}catch(a){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),s(a)}}))}))}drawImageInChunks(e,t,n,i){return l(this,null,(function*(){return new Promise(((s,a)=>{try{const r=200;let o=0;const c=()=>{if(o>=i)return void s();const l=Math.min(r,i-o),h=o/i*t.naturalHeight,d=l/i*t.naturalHeight;try{e.drawImage(t,0,h,t.naturalWidth,d,0,o,n,l),o+=l,setTimeout(c,10)}catch(u){a(u)}};c()}catch(r){a(r)}}))}))}extremeCompressForScan(e){return l(this,null,(function*(){return new Promise(((t,n)=>{try{this.uiManager&&this.uiManager.showProcessingTip&&this.uiManager.showProcessingTip("正在极限压缩图片，请稍候...");const i=document.createElement("canvas"),s=i.getContext("2d"),a=400;i.width=a,i.height=a,s.imageSmoothingEnabled=!1,setTimeout((()=>{try{s.drawImage(e,0,0,a,a),e.src&&"string"==typeof e.src&&(e.src=""),this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),t(i)}catch(r){this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),n(r)}}),100)}catch(i){n(i)}}))}))}processImageWithWorker(e,t="standard"){return l(this,null,(function*(){if(!this.workerManager)throw new Error("Worker管理器未初始化");try{const n=document.createElement("canvas"),i=n.getContext("2d");n.width=e.naturalWidth,n.height=e.naturalHeight,i.drawImage(e,0,0);const s=i.getImageData(0,0,n.width,n.height);let a;const r=(e,t)=>{this.uiManager&&this.uiManager.updateProcessingProgress&&this.uiManager.updateProcessingProgress(e,t)};if(a="extreme"===t?yield this.workerManager.compressImage(s,400,400,.4,r):yield this.workerManager.compressImage(s,800,400,.6,r),!a||!a.imageData)throw new Error("Worker处理返回无效结果");const o=document.createElement("canvas"),c=o.getContext("2d");return o.width=a.imageData.width,o.height=a.imageData.height,c.putImageData(a.imageData,0,0),o}catch(n){throw new Error("图片处理失败: "+n.message)}}))}compressImage(e,t=800,n=.6){return l(this,null,(function*(){const i=e.naturalWidth*e.naturalHeight;if(this.workerManager)try{const t=i>4e6?"extreme":"standard";return yield this.processImageWithWorker(e,t)}catch(s){}return i>4e6?this.extremeCompressForScan(e):this.compressImageForScan(e,t,400,n)}))}calculateOptimalScanSize(e,t,n,i){let s=e,a=t;const r=Math.min(n/s,n/a);if(r<1&&(s=Math.floor(s*r),a=Math.floor(a*r)),s<i&&a<i){const e=Math.max(i/s,i/a);s=Math.floor(s*e),a=Math.floor(a*e)}const o=Math.floor((s+a)/2);if(o<=n&&o>=i){const e=Math.min(o,600);return{width:e,height:e}}return{width:s,height:a}}calculateCompressedSize(e,t,n){return this.calculateOptimalScanSize(e,t,n,400)}formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}waitForDecodeCompletion(e=2e3){return l(this,null,(function*(){const t=Date.now();for(;this.currentDecodeCount>0&&Date.now()-t<e;)yield new Promise((e=>setTimeout(e,50)));this.currentDecodeCount>0&&(this.currentDecodeCount=0,this.isDecoding=!1)}))}handleUIClose(){if(this.isScanning||this.isInitializing){if(this.stopScan(),this.currentOptions){const e="scanCode:fail cancel";this.currentOptions.fail&&this.currentOptions.fail({errMsg:e}),this.currentOptions.complete&&this.currentOptions.complete({errMsg:e})}}else this.uiManager.removeScannerUI(),this.unbindUIEvents()}handleUniImageSelected(e){return l(this,null,(function*(){const t=e.detail.tempFilePath;if(t&&this.qrCodeDecoder)try{yield this.processUniSelectedImage(t)}catch(n){this.hideScannerUIAfterImageProcess(!1,n.message||"图片处理失败")}}))}hideScannerUIAfterImageProcess(e,t=""){setTimeout((()=>{try{this.uiManager&&this.uiManager.hideProcessingTip&&this.uiManager.hideProcessingTip(),this.stopScan()}catch(e){}}),e?1e3:1500)}handleFileSelected(e){return l(this,null,(function*(){const t=e.detail.file;if(t&&this.qrCodeDecoder)try{setTimeout((()=>l(this,null,(function*(){const e=new Image;e.onload=()=>l(this,null,(function*(){var n;try{let i=e;e.naturalWidth*e.naturalHeight>4e6||t.size>3145728?i=yield this.extremeCompressForScan(e):(e.naturalWidth>800||e.naturalHeight>800||t.size>1048576)&&(i=yield this.compressImageForScan(e,800,400,.6));const s=(null==(n=this.currentOptions)?void 0:n.scanType)||[],a=yield this.qrCodeDecoder.decode(i,s);a?(this.handleScanSuccess(a,"album"),this.hideScannerUIAfterImageProcess(!0,"识别成功")):this.hideScannerUIAfterImageProcess(!1,"图片中未找到指定类型的条码")}catch(i){this.hideScannerUIAfterImageProcess(!1,"图片扫码失败: "+i.message)}})),e.onerror=()=>{this.hideScannerUIAfterImageProcess(!1,"图片加载失败")};const n=new FileReader;n.onload=t=>{e.src=t.target.result},n.onerror=()=>{this.hideScannerUIAfterImageProcess(!1,"文件读取失败")},n.readAsDataURL(t)}))),50)}catch(n){this.hideScannerUIAfterImageProcess(!1,"处理图片文件失败")}}))}startScanLoop(){if(!this.isScanning||this.scanLoopActive||this.isDestroyed)return;this.scanLoopActive=!0;const e=()=>l(this,null,(function*(){var t;if(!this.isScanning||!this.scanLoopActive||this.isDestroyed)return void(this.scanLoopActive=!1);const n=Date.now();if(n-this.lastScanTime<this.scanInterval)this.scanAnimationId=requestAnimationFrame(e);else if(this.isDecoding||this.currentDecodeCount>=this.maxConcurrentDecodes)this.scanAnimationId=requestAnimationFrame(e);else{this.lastScanTime=n;try{const e=this.cameraScanner.getImageData();if(e&&this.isScanning){const n=(null==(t=this.currentOptions)?void 0:t.scanType)||[];this.isDecoding=!0,this.currentDecodeCount++,this.performDecode(e,n).finally((()=>{this.isDecoding=!1,this.currentDecodeCount=Math.max(0,this.currentDecodeCount-1)}))}}catch(i){this.isDecoding=!1,this.currentDecodeCount=Math.max(0,this.currentDecodeCount-1)}this.isScanning&&this.scanLoopActive&&(this.scanAnimationId=requestAnimationFrame(e))}}));this.scanAnimationId=requestAnimationFrame(e)}performDecode(e,t){return l(this,null,(function*(){return new Promise((n=>{setTimeout((()=>l(this,null,(function*(){try{if(!this.isScanning||this.isDestroyed)return void n();this.scanCount++,this.scanCount>=this.maxScanCount&&(yield this.restartDecoder());const i=yield this.qrCodeDecoder.decode(e,t);i&&this.isScanning&&!this.isDestroyed&&this.handleScanSuccess(i,"camera")}catch(i){}finally{n()}}))),100)}))}))}handleScanSuccess(e,t="camera"){this.cleanup(),navigator.vibrate&&navigator.vibrate(200);const n=this.buildScanResult(e,t);setTimeout((()=>{this.stopScan(),this.currentOptions&&(this.currentOptions.success&&this.currentOptions.success(n),this.currentOptions.complete&&this.currentOptions.complete(n))}),0)}buildScanResult(e,t){const n={result:e.text,scanType:e.scanType||this.detectScanType(e.text),charSet:"UTF-8",errMsg:"scanCode:ok"};if(t&&(n.imageChannel=t),e.format&&(n.format=e.format),e.data)try{n.rawData=btoa(e.text)}catch(i){n.rawData=e.text}return n}detectScanType(e){return"qrCode"}handleScanError(e){this.cleanup(),setTimeout((()=>{if(this.stopScan(),this.currentOptions){const t="scanCode:fail "+e;this.currentOptions.fail&&this.currentOptions.fail({errMsg:t}),this.currentOptions.complete&&this.currentOptions.complete({errMsg:t})}}),0)}static isCameraSupported(){return l(this,null,(function*(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return!1;return(yield navigator.mediaDevices.enumerateDevices()).some((e=>"videoinput"===e.kind))}catch(e){return!1}}))}static getCameras(){return l(this,null,(function*(){return yield te.getCameras()}))}static isBarcodeDetectorSupported(){return ne.isBarcodeDetectorSupported()}static getSupportedFormats(){return l(this,null,(function*(){return yield ne.getSupportedFormats()}))}static getPluginInfo(){return{name:"jz-h5-scanCode",version:"1.0.0",description:"H5环境下的二维码扫描插件，与uni.scanCode API兼容",author:"JZ",cameraSupported:navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,barcodeDetectorSupported:"BarcodeDetector"in window,platforms:{h5:"自定义扫码实现",app:"uni.scanCode","mp-weixin":"uni.scanCode","mp-alipay":"uni.scanCode","mp-baidu":"uni.scanCode"}}}}const re=new ae,oe=e=>re.scanCode(e),ce=()=>re.stopScan(),le=(ae.isCameraSupported,ae.getCameras,ae.isBarcodeDetectorSupported,ae.getSupportedFormats,ae.getPluginInfo,L(f({__name:"ExTabbar",props:{active:{type:String,default:"home"}},setup(e,{expose:t}){const n=e,i=W(),s=O({deviceSn:""}),a=w([{key:"home",name:"首页"},{key:"mine",name:"我的"}]);const r=_("tabbar-msg-box"),o=w(!1),c=w([{name:"老人"},{name:"儿童"},{name:"宠物"}]);function h(){i.phone?oe({onlyFromCamera:!0,success:e=>{const t=function(e){const t=/[?&]sn=([^&]+)/,n=e.match(t);if(n&&n[1])return n[1];return null}(e.result);t?d(t):r.alert(`无效的二维码：${e.result}`)},fail:e=>l(this,[e],(function*({errMsg:e}){yield ce(),r.alert("扫码失败:"+e)}))}):X({url:"/pages/login/login"})}function d(e){return l(this,null,(function*(){s.deviceSn=e;const{code:t,data:n}=yield Z({deviceSn:e});if(0===t&&n.records.length>0){const{phone:t}=n.records[0];t!==i.phone?J({url:`/pages/info/info?phone=${t}&deviceSn=${e}`}):J({url:`/pages/form/form?phone=${t}&deviceSn=${e}`})}else r.confirm({msg:"该设备尚未绑定，是否立即绑定",cancelButtonText:"取消",confirmButtonText:"立即绑定",cancelButtonProps:{size:"large"},confirmButtonProps:{size:"large"}}).then((()=>{o.value=!0})).catch((()=>{}))}))}function u({item:e}){const{deviceSn:t}=s;J({url:`/pages/form/form?phone=${i.phone}&deviceSn=${t}&type=${e.name}`})}return t({bindDevice:d}),(e,t)=>{const s=R,r=$,l=x,d=q(N("wd-action-sheet"),ee),g=q(N("wd-message-box"),V);return A(),v(l,{class:"ex-tabbar"},{default:C((()=>[b(l,{class:"fixed inset-6 top-auto flex-between-center text-2.5 text-white"},{default:C((()=>[b(l,{class:"flex-center w-[182rpx] h-15 rounded-full bg-[#5db661]"},{default:C((()=>[b(l,{class:"flex-between-center flex-col h-8",onClick:h},{default:C((()=>[b(s,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAACFSURBVHgB1ZPRDYAgDEQPJ3AENpcNdANGwg1qa47YHwVDYuJL+gHk2gNaQBGRqJE1iobgBrlYTQMnLu6wJ4FQE8FsRtKY0YAFEzXZZ43oxApVF6FaDgpe8HTVbwmjVib8nuFvtDfYudHsQieOfpHZVUtPN7ILF2q28WGqltxQtRIUuj7FB02G8Z90RKOgAAAAAElFTkSuQmCC",class:"w-4 h-4",mode:"scaleToFill"}),b(r,{class:"leading-2.5"},{default:C((()=>[D("绑定设备")])),_:1})])),_:1})])),_:1}),b(l,{class:"flex-between-center w-[384rpx] h-15 p-1 rounded-full bg-black box-border"},{default:C((()=>[(A(!0),P(U,null,z(Y(a),(e=>(A(),v(l,{key:e.key,class:I(["flex-1 flex-between-center flex-col h-8",{active:n.active===e.key}]),onClick:t=>function(e){if(n.active!==e){if("mine"===e&&!i.phone)return void J({url:"/pages/login/login"});X({url:"mine"===e?"/pages/mine/mine":"/pages/index/index"})}}(e.key)},{default:C((()=>["home"===e.key&&"home"===n.active?(A(),v(s,{key:0,src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAB9SURBVHgBxZHLDYAgDEDrZwBHcBMZhQ0YwRGYyZs3R5ANdAPtoZCmEUE88JKXQOBBAh3EMehK4wUyGVCLXkybE47oJkLvTuuPKPSIhPwAJUOTiKSzD+3HMLxDQ4MiWvhBvbgX85OMMZAB/oIa3tF8v7x5SsSKT+p+lYMy3A27KT1W/b3fpwAAAABJRU5ErkJggg==",class:"w-[30rpx] h-4",mode:"scaleToFill"})):M("",!0),"home"===e.key&&"home"!==n.active?(A(),v(s,{key:1,src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAB8SURBVHgBxZHRDYAgDESrcQBGcBMZhQ0cgREYzRFkA92gtgETJBYJfvCSI2m4g7QFEEDEFQMWaiGzIjl84mqCM2nDd3a+l4KadGAZfkBL/dVi76DDNtzAJzQywg/6haesPqMkVFQgm6ApBNlrUnP+8/IxfJ0WfVfloQ1/Ab9uCIv7lYcFAAAAAElFTkSuQmCC",class:"w-[30rpx] h-4",mode:"scaleToFill"})):M("",!0),"mine"===e.key&&"mine"===n.active?(A(),v(s,{key:2,src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAACUSURBVHgBpZJhDYAgEEZPC6gNiGAEm1jBKDYwghGMoA3UBNoAj+3YGHJ3Tr7tDX7wDrgdwDsGGZELsciK9PAhTtxJipk0eWFETy/dahWWUCgjWYvh5Bv0iGe4ZnkGSe4E0RWuQUmXeMGcEguhSEvrAcxfQ9nQrRXSJM66iTup2BZK2nDErOSpHWYbWNDmV0rISJb8APmHVD7sAP3xAAAAAElFTkSuQmCC",class:"w-[30rpx] h-4",mode:"scaleToFill"})):M("",!0),"mine"===e.key&&"mine"!==n.active?(A(),v(s,{key:3,src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAACjSURBVHgBpZIBDcMgEEXvamCbAyRMQp3U0hwsUzAJlbA6gCloHdw+GWkIud417Ut+IIF35ACiBhEJyAOZ5c8HGcijiFF0np48is1gneox1k5XzQP5hC15IZ9FlZl5wpAc+bW5gp56o9+IXMmiFIiN+NZENorcyzShJfU+uNocMPTIBbkpe2fkW4pNq7Tjc7TkLxs490f73rglZVnoIB2d4JT8AxrsDMR+z4UFAAAAAElFTkSuQmCC",class:"w-[30rpx] h-4",mode:"scaleToFill"})):M("",!0),b(r,{class:"leading-2.5"},{default:C((()=>[D(T(e.name),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),b(d,{modelValue:Y(o),"onUpdate:modelValue":t[0]||(t[0]=e=>G(o)?o.value=e:null),actions:Y(c),"cancel-text":"取消",onClose:t[1]||(t[1]=e=>o.value=!1),onSelect:u},null,8,["modelValue","actions"]),b(g,{selector:"tabbar-msg-box","custom-class":"ex-message-box"})])),_:1})}}}),[["__scopeId","data-v-24cf36e7"]]));export{le as E};
